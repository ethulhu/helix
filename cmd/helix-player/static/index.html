<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset='utf-8'>
	<title>Helix Player</title>
	<style>
:root {
	--background-color:  hsl(0, 0%, 100%);
	--callout-color:     hsl(0, 0%, 90%);

	--foreground-color:  hsl(0, 0%, 0%);
	--highlight-color:   hsl(205, 69%, 50%);
}
@media (prefers-color-scheme: dark) {
	:root {
		--background-color:  hsl(0, 0%, 12%);
		--callout-color:     hsl(0, 0%, 24%);

		--foreground-color:  hsl(0, 0%, 82%);
		--highlight-color:   hsl(259, 49%, 65%);
	}
}

body {
	background-color:  var(--background-color);
	color:             var(--foreground-color);

	font-size:    14pt;
	font-family:  sans-serif;

	min-width:    12em;
	padding:      0.5em;
}
@media screen and ( min-width: 40em ) {
	body {
		margin:     0 auto;
		max-width:  30em;
	}
}
button, select, details {
	background-color:  var(--callout-color);
	color:             var(--foreground-color);

	font-size:    12pt;
	font-family:  sans-serif;

	border-radius:  5px;
	border:         solid 3px var(--callout-color);
	filter:         drop-shadow(1px 1px 1px black);
	margin-top:     3px;
	margin-bottom:  3px;
}
button:active {
	filter:     drop-shadow(1px 1px 0.5px black);
	transform:  translateY(1px);
}

main {
	height: 100vh;

	display: grid;
	grid-template-areas: "player" "directory";
	grid-template-rows: auto 1fr;
}
#player {
	grid-area: player;
}
helix-playlist::part(current) {
	color: var(--highlight-color);
}

helix-directory-tree {
	grid-area: directory;
	overflow-y: scroll;
}
	</style>
</head>

<body>
	<main>
		<div id='player'>
			<helix-media-player></helix-media-player>
			<helix-media-controls duration='100'></helix-media-controls>
			<details>
				<summary>playlist</summary>
				<helix-playlist></helix-playlist>
			</details>
		</div>


		<helix-directory-tree></helix-directory-tree>
	</main>

	<script type='module'>
		import './directory.js';
		import './media-controls.js';
		import './media-player.js';
		import './playlist.js';

		import { elemGenerator } from './elems.js';
		const _li     = elemGenerator( 'li' );
		const _source = elemGenerator( 'source' );

		CustomElementRegistry.prototype.whenAllDefined = function( kinds ) {
			return Promise.all( kinds.map( k => this.whenDefined( k ) ) );
		}

		const elementKinds = [
			'helix-directory-tree',
			'helix-media-controls',
			'helix-media-player',
			'helix-playlist',
		];

		customElements.whenAllDefined( elementKinds ).then( () => {
			const controls = document.querySelector( 'helix-media-controls' );
			const directoryTree = document.querySelector( 'helix-directory-tree' );
			const player = document.querySelector( 'helix-media-player' );
			const playlist = document.querySelector( 'helix-playlist' );

			directoryTree.addEventListener( 'enqueue', e => {
				const item = e.detail;

				const mimetype = item.mimetypes.filter( m => player.canPlayType( m ) )[ 0 ];
				const url = `/directories/${item.directory}/${item.id}?accept=${mimetype}`;

				playlist.appendChild( _li( item.title, _source( { src: url } ) ) );
			} );

	controls.addEventListener( 'playpause', e => {
				if ( player.paused ) {
					player.play();
				} else {
					player.pause();
				}
			} );
			controls.addEventListener( 'skip', e => {
				playlist.skip();
			} );
			controls.addEventListener( 'seek', e => {
				player.currentTime = e.detail;
			} );

			player.addEventListener( 'durationchange', e => {
				controls.duration = e.target.duration;
			} );
			player.addEventListener( 'timeupdate', e => {
				controls.currentTime = e.target.currentTime;
			} );
			player.addEventListener( 'ended', e => {
				console.log( 'track ended' );
				playlist.skip();
			} );

			playlist.addEventListener( 'trackchanged', e => {
				console.log( 'track changed' );
				player.src = e.detail.getElementsByTagName( 'source' )[ 0 ].src;
				player.play();
			} );
		} );
	</script>
</body>
</html>
