<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset='utf-8'>
	<title>Helix Player</title>
	<style>
@import url( "common.css" );

main {
	height: 100vh;

	display: grid;
	grid-template-areas: "player" "directory";
	grid-template-rows: auto 1fr;
}
#player {
	grid-area: player;
}

helix-directory-tree {
	grid-area: directory;
	overflow-y: scroll;
}
	</style>
</head>

<body>
	<main>
		<div id='player'>
			<helix-media-player></helix-media-player>
			<helix-media-controls duration='100'></helix-media-controls>
			<details>
				<summary>playlist</summary>
				<helix-playlist></helix-playlist>
			</details>
		</div>


		<helix-directory-tree></helix-directory-tree>
	</main>

	<script type='module'>
		import './directory.js';
		import './media-controls.js';
		import './media-player.js';
		import './playlist.js';

		import { elemGenerator } from './elems.js';
		const _li     = elemGenerator( 'li' );
		const _source = elemGenerator( 'source' );

		CustomElementRegistry.prototype.whenAllDefined = function( kinds ) {
			return Promise.all( kinds.map( k => this.whenDefined( k ) ) );
		}

		const elementKinds = [
			'helix-directory-tree',
			'helix-media-controls',
			'helix-media-player',
			'helix-playlist',
		];

		customElements.whenAllDefined( elementKinds ).then( () => {
			const controls = document.querySelector( 'helix-media-controls' );
			const directoryTree = document.querySelector( 'helix-directory-tree' );
			const player = document.querySelector( 'helix-media-player' );
			const playlist = document.querySelector( 'helix-playlist' );

			directoryTree.addEventListener( 'enqueue', e => {
				const item = e.detail;

				const mimetype = item.mimetypes.filter( m => player.canPlayType( m ) )[ 0 ];
				const url = `/directories/${item.directory}/${item.id}?accept=${mimetype}`;

				playlist.appendChild( _li( item.title, _source( { src: url } ) ) );
			} );

	controls.addEventListener( 'playpause', e => {
				if ( player.paused ) {
					player.play();
				} else {
					player.pause();
				}
			} );
			controls.addEventListener( 'skip', e => {
				playlist.skip();
			} );
			controls.addEventListener( 'seek', e => {
				player.currentTime = e.detail;
			} );

			player.addEventListener( 'durationchange', e => {
				controls.duration = e.target.duration;
			} );
			player.addEventListener( 'timeupdate', e => {
				controls.currentTime = e.target.currentTime;
			} );
			player.addEventListener( 'ended', e => {
				console.log( 'track ended' );
				playlist.skip();
			} );

			playlist.addEventListener( 'trackchanged', e => {
				console.log( 'track changed' );
				player.src = e.detail.getElementsByTagName( 'source' )[ 0 ].src;
				player.play();
			} );
		} );
	</script>
</body>
</html>
